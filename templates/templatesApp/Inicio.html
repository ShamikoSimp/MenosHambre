{% extends 'templatesApp/base.html' %}
{% load static %}

{% block content %}
<main class="main-container">
  <div class="carrusel-pequeno">
    <div id="carouselExample" class="carousel slide">
      <div class="carousel-inner">
        <div class="carousel-item active">
          <div class="carrusel-overlay">
            <img src="{% static 'images/comun.jpg' %}" class="d-block w-100 carrusel-img" alt="...">
            <div class="carrusel-texto">춰Bienvenido! Apoya, publica y dona para tu comunidad</div>
          </div>
        </div>
        <div class="carousel-item">
          <div class="carrusel-overlay">
            <img src="{% static 'images/comedor.jpg' %}" class="d-block w-100 carrusel-img" alt="...">
            <div class="carrusel-texto">Juntos llegamos m치s lejos</div>
          </div>
        </div>
      </div>
      <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
      </button>
    </div>
  </div>
<div class="cards">
<div class="cards mt-4 mb-4">
  {% if not request.session.id_usuario or not request.session.es_admin %}
  <div class="card card-efecto sombra-card" style="width: 18rem; background: #f8fafc;">
    <img src="{% static 'images/olla.jpg' %}" class="card-img-top" alt="...">
    <div class="card-body">
      <h5 class="card-title text-primary-emphasis">Publica Gratis!</h5>
      <p class="card-text">Publica zonas de ollas comunes, comedores o similares.</p>
      {% if request.session.id_usuario %}
        <a href="{% url 'tipopublicacion' %}?usuario={% if request.session.tipo_usuario == 'usuario' %}normal{% else %}organizacion{% endif %}" class="btn btn-warning btn-lg w-100 mb-2">Publicar</a>
      {% else %}
      <div class="alert alert-info" role="alert">
          <i class="bi bi-info-circle"></i> Registrate para publicar
        </div>
        <div class="d-grid">
          <a href="{% url 'registro' %}?tipo=usuario" class="btn btn-primary btn-lg w-100">Registrar como Usuario individual</a>
          <hr class="my-2" style="border-top:1px solid rgba(0,0,0,.08);">
          <a href="{% url 'registro' %}?tipo=organizacion" class="btn btn-primary btn-lg w-100">Registrar como Organizacion</a>
        </div>
        
        <div class="mt-3 text-center">
    <p>쯏a tienes una cuenta? <a href="{% url 'acceso' %}" class="text-primary">Inicia sesi칩n aqu칤</a></p>
  </div>
      {% endif %}
    </div>
  </div>
  {% endif %}
  <!-- Card de donaci칩n: solo visible para usuarios no logueados o no-admin -->
  {% if not request.session.id_usuario or not request.session.es_admin %}
  <div class="card card-efecto sombra-card" style="width: 18rem; background: #f8fafc;">
    <img src="{% static 'images/donacion.jpg' %}" class="card-img-top" alt="...">
    <div class="card-body">
      <h5 class="card-title text-success">Aporta donaciones!</h5>
      <p class="card-text">Realiza un aporte monetario para continuar apoyando familias.</p>
      {% if request.session.id_usuario %}
        <div class="d-grid">
          <a href="{% url 'donacion' %}" class="btn btn-outline-success btn-lg w-100">Donar en especie</a>
        </div>
      {% else %}
        <div class="alert alert-info" role="alert">
          <i class="bi bi-info-circle"></i> Inicia sesi칩n para donar
        </div>
        <div class="d-grid">
          <a href="{% url 'registro' %}?tipo=usuario" class="btn btn-primary btn-lg w-100">Registrar como Usuario individual</a>
          <hr class="my-2" style="border-top:1px solid rgba(0,0,0,.08);">
          <a href="{% url 'registro' %}?tipo=organizacion" class="btn btn-primary btn-lg w-100">Registrar como Organizacion</a>
        </div>
        
        <div class="mt-3 text-center">
    <p>쯏a tienes una cuenta? <a href="{% url 'acceso' %}" class="text-primary">Inicia sesi칩n aqu칤</a></p>
  </div>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>
</div>
  <!--Publicaciones-->
  <div class="publicaciones-container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="h3 mb-0">Publicaciones</h2>
    </div>
    <div class="row row-cols-1 row-cols-md-3 g-4">
      {% for pub in publicaciones %}
      <div class="col">
        <div class="card h-100 card-efecto sombra-card publicacion-card">
          <div class="card-body d-flex flex-column justify-content-between">
            <div>
              <button class="btn btn-warning" type="button"onclick="leerPublicacion({{ pub.id_publicacion }})">
                 游댉 Escuchar
              </button>
              <h5 class="card-title text-primary-emphasis mb-3">{{ pub.titulo }}</h5>
              <p class="card-text mb-3">{{ pub.descripcion }}</p>
              <div class="d-flex gap-2 flex-wrap">
                <span class="badge bg-primary"><i class="bi bi-geo-alt"></i> {{ pub.direccion }}</span>
                <span class="badge bg-success"><i class="bi bi-tag"></i> {{ pub.tipo_publicacion }}</span>
              </div>
            </div>
            <div class="mt-3 text-end">
              <small class="text-muted">{{ pub.fecha_publicacion }}</small>
            </div>
          </div>
        </div>
      </div>
      {% empty %}
      <div class="col-12">
        <div class="alert alert-info">No hay publicaciones registradas.</div>
      </div>
      {% endfor %}
    </div>
  </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
function leerPublicacion(id) {
  console.log('leerPublicacion called with ID:', id);
    
  const url = `/leer-publicacion/${id}/`;
  console.log('Fetching URL:', url);

  fetch(url)
    .then(response => {
      console.log('Response status:', response.status);
      console.log('Response ok:', response.ok);
      console.log('Content-Type:', response.headers.get('content-type'));
            
      if (!response.ok) {
        console.error('Response error:', response.statusText);
        alert(`Error al obtener audio (HTTP ${response.status})`);
        return null;
      }
      return response.blob();
    })
    .then(audioBlob => {
      if (!audioBlob) {
        console.error('No blob received');
        return;
      }
            
      console.log('Blob received:', audioBlob.size, 'bytes, type:', audioBlob.type);

      // Crear URL temporal para el MP3
      const url = URL.createObjectURL(audioBlob);
      console.log('Object URL created:', url);
            
      const audio = new Audio(url);
      console.log('Audio element created');

      audio.onplay = () => console.log('Audio started playing');
      audio.onended = () => {
        console.log('Audio ended');
        URL.revokeObjectURL(url);
      };
      audio.onerror = (e) => {
        console.error('Audio error:', e);
        alert('Error al reproducir el audio');
      };

      audio.play().then(() => {
        console.log('Play promise resolved');
      }).catch((error) => {
        console.error('Play error:', error);
        alert('Error al reproducir: ' + error.message);
      });
    })
    .catch((error) => {
      console.error('Fetch error:', error);
      alert('Error inesperado: ' + error.message);
    });
}
</script>
{% endblock %}